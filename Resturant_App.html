<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurant Command Center - MetaStack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      body {
        font-family: "Lato", sans-serif;
        background-color: #fdf8f0;
        color: #4a4a4a;
      }
      .title-font {
        font-family: "Playfair Display", serif;
      }
      .print-area {
        display: none;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        .print-area,
        .print-area * {
          visibility: visible;
        }
        .print-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .no-print {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // --- Sample Data ---
      const initialMenuItems = [
        { id: 1, name: "Paneer Tikka", category: "Appetizers", price: 280 },
        {
          id: 2,
          name: "Mushroom Salt & Pepper",
          category: "Appetizers",
          price: 250,
        },
        { id: 3, name: "Dal Makhani", category: "Main Course", price: 350 },
        {
          id: 4,
          name: "Paneer Butter Masala",
          category: "Main Course",
          price: 370,
        },
        { id: 5, name: "Garlic Naan", category: "Breads", price: 75 },
        { id: 6, name: "Jeera Rice", category: "Rice", price: 200 },
        { id: 7, name: "Gulab Jamun", category: "Desserts", price: 150 },
        { id: 8, name: "Mineral Water", category: "Beverages", price: 30 },
      ];

      // --- Main App Component ---
      function App() {
        const [menuItems, setMenuItems] = useState(initialMenuItems);
        const [currentOrder, setCurrentOrder] = useState([]);
        const [tableNumber, setTableNumber] = useState(1);
        const [showKOT, setShowKOT] = useState(false);
        const [showBill, setShowBill] = useState(false);
        const [orderId, setOrderId] = useState(101);
        const [isEditingMenu, setIsEditingMenu] = useState(false);

        const addToOrder = (item) => {
          setCurrentOrder((prevOrder) => {
            const existingItem = prevOrder.find(
              (orderItem) => orderItem.id === item.id
            );
            if (existingItem) {
              return prevOrder.map((orderItem) =>
                orderItem.id === item.id
                  ? { ...orderItem, quantity: orderItem.quantity + 1 }
                  : orderItem
              );
            }
            return [...prevOrder, { ...item, quantity: 1 }];
          });
        };

        const updateQuantity = (itemId, amount) => {
          setCurrentOrder((prevOrder) => {
            return prevOrder
              .map((item) =>
                item.id === itemId
                  ? { ...item, quantity: Math.max(0, item.quantity + amount) }
                  : item
              )
              .filter((item) => item.quantity > 0);
          });
        };

        const clearOrder = () => {
          setCurrentOrder([]);
          setTableNumber(1);
          setShowKOT(false);
          setShowBill(false);
        };

        const generateAndShowKOT = () => {
          if (currentOrder.length > 0) setShowKOT(true);
        };

        const generateAndShowBill = () => {
          if (currentOrder.length > 0) setShowBill(true);
        };

        const handlePrint = () => {
          window.print();
        };

        const handleGeneratePdf = (elementId, fileName) => {
          const input = document.getElementById(elementId);
          html2canvas(input, { scale: 2 }) // Higher scale for better quality
            .then((canvas) => {
              const imgData = canvas.toDataURL("image/png");
              const pdf = new jspdf.jsPDF({
                orientation: "portrait",
                unit: "pt",
                format: [canvas.width, canvas.height],
              });
              pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
              pdf.save(`${fileName}.pdf`);
            });
        };

        const subtotal = currentOrder.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        const gst = subtotal * 0.05;
        const total = subtotal + gst;

        const handleSaveMenu = (newMenu) => {
          setMenuItems(newMenu);
          setIsEditingMenu(false);
        };

        if (isEditingMenu) {
          return (
            <MenuEditor
              menuItems={menuItems}
              onSave={handleSaveMenu}
              onCancel={() => setIsEditingMenu(false)}
            />
          );
        }

        return (
          <div className="min-h-screen bg-[#FDF8F0]">
            <header className="bg-white shadow-sm p-4 border-b border-yellow-800/20 flex justify-between items-center">
              <div>
                <h1 className="title-font text-3xl text-center text-[#2D2D2D]">
                  Restaurant Command Center
                </h1>
                <p className="text-center text-gray-500">by MetaStack</p>
              </div>
              <button
                onClick={() => setIsEditingMenu(true)}
                className="bg-[#4A4A4A] text-white py-2 px-4 rounded-lg hover:bg-black transition-colors"
              >
                Edit Menu
              </button>
            </header>
            <main className="grid grid-cols-1 lg:grid-cols-2 gap-8 p-8 max-w-7xl mx-auto">
              <MenuSelection menuItems={menuItems} onAddToOrder={addToOrder} />
              <CurrentOrder
                order={currentOrder}
                onUpdateQuantity={updateQuantity}
                tableNumber={tableNumber}
                setTableNumber={setTableNumber}
                onGenerateKOT={generateAndShowKOT}
                onGenerateBill={generateAndShowBill}
                subtotal={subtotal}
                gst={gst}
                total={total}
              />
            </main>

            {showKOT && (
              <KOTView
                order={currentOrder}
                tableNumber={tableNumber}
                orderId={orderId}
                onPrint={handlePrint}
                onClose={() => setShowKOT(false)}
                onGeneratePdf={() =>
                  handleGeneratePdf("kot-content", `KOT_${orderId}`)
                }
              />
            )}

            {showBill && (
              <BillView
                order={currentOrder}
                tableNumber={tableNumber}
                orderId={orderId}
                subtotal={subtotal}
                gst={gst}
                total={total}
                onPrint={handlePrint}
                onNewOrder={() => {
                  setOrderId((prev) => prev + 1);
                  clearOrder();
                }}
                onGeneratePdf={() =>
                  handleGeneratePdf("bill-content", `Bill_${orderId}`)
                }
              />
            )}
          </div>
        );
      }

      // --- Components ---

      function MenuEditor({ menuItems, onSave, onCancel }) {
        const [editedMenu, setEditedMenu] = useState(
          JSON.parse(JSON.stringify(menuItems))
        );

        const handleItemChange = (id, field, value) => {
          setEditedMenu((prevMenu) =>
            prevMenu.map((item) =>
              item.id === id
                ? {
                    ...item,
                    [field]: field === "price" ? parseInt(value) || 0 : value,
                  }
                : item
            )
          );
        };

        const addNewItem = (category) => {
          const newItem = {
            id: Date.now(),
            name: "New Item",
            category: category,
            price: 0,
          };
          setEditedMenu((prevMenu) => [...prevMenu, newItem]);
        };

        const removeItem = (id) => {
          setEditedMenu((prevMenu) =>
            prevMenu.filter((item) => item.id !== id)
          );
        };

        const categories = [
          ...new Set(editedMenu.map((item) => item.category)),
        ];

        return (
          <div className="p-8">
            <div className="flex justify-between items-center mb-6">
              <h1 className="title-font text-3xl">Menu Editor</h1>
              <div className="flex gap-4">
                <button
                  onClick={onCancel}
                  className="bg-gray-300 py-2 px-6 rounded-lg"
                >
                  Cancel
                </button>
                <button
                  onClick={() => onSave(editedMenu)}
                  className="bg-[#B8860B] text-white py-2 px-6 rounded-lg"
                >
                  Save Changes
                </button>
              </div>
            </div>
            <div className="space-y-6">
              {categories.map((category) => (
                <div
                  key={category}
                  className="bg-white p-4 rounded-lg shadow-sm"
                >
                  <h3 className="title-font text-2xl text-[#B8860B] mb-3">
                    {category}
                  </h3>
                  <div className="space-y-2">
                    {editedMenu
                      .filter((item) => item.category === category)
                      .map((item) => (
                        <div
                          key={item.id}
                          className="grid grid-cols-12 gap-2 items-center"
                        >
                          <input
                            type="text"
                            value={item.name}
                            onChange={(e) =>
                              handleItemChange(item.id, "name", e.target.value)
                            }
                            className="col-span-6 p-2 border rounded"
                          />
                          <input
                            type="number"
                            value={item.price}
                            onChange={(e) =>
                              handleItemChange(item.id, "price", e.target.value)
                            }
                            className="col-span-4 p-2 border rounded"
                          />
                          <button
                            onClick={() => removeItem(item.id)}
                            className="col-span-2 bg-red-500 text-white p-2 rounded"
                          >
                            Remove
                          </button>
                        </div>
                      ))}
                  </div>
                  <button
                    onClick={() => addNewItem(category)}
                    className="mt-4 bg-green-500 text-white py-1 px-3 rounded text-sm"
                  >
                    + Add Item to {category}
                  </button>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function MenuSelection({ menuItems, onAddToOrder }) {
        const categories = [...new Set(menuItems.map((item) => item.category))];

        return (
          <div className="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-yellow-800/10">
            <h2 className="title-font text-2xl mb-4 border-b pb-2 border-yellow-800/20">
              Menu
            </h2>
            {categories.map((category) => (
              <div key={category} className="mb-6">
                <h3 className="title-font text-xl text-[#B8860B] mb-3">
                  {category}
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {menuItems
                    .filter((item) => item.category === category)
                    .map((item) => (
                      <div
                        key={item.id}
                        onClick={() => onAddToOrder(item)}
                        className="bg-[#FDF8F0] p-3 rounded-lg shadow-sm cursor-pointer hover:shadow-md hover:bg-white transition-all duration-200 flex justify-between items-center"
                      >
                        <span>{item.name}</span>
                        <span className="font-semibold text-gray-600">
                          ₹{item.price}
                        </span>
                      </div>
                    ))}
                </div>
              </div>
            ))}
          </div>
        );
      }

      function CurrentOrder({
        order,
        onUpdateQuantity,
        tableNumber,
        setTableNumber,
        onGenerateKOT,
        onGenerateBill,
        subtotal,
        gst,
        total,
      }) {
        return (
          <div className="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-yellow-800/10 h-fit sticky top-8">
            <h2 className="title-font text-2xl mb-4 border-b pb-2 border-yellow-800/20">
              Current Order
            </h2>
            <div className="mb-4">
              <label
                htmlFor="table-number"
                className="block text-sm font-medium text-gray-700"
              >
                Table Number
              </label>
              <input
                type="number"
                id="table-number"
                value={tableNumber}
                onChange={(e) => setTableNumber(e.target.value)}
                className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#B8860B] focus:border-[#B8860B] sm:text-sm"
              />
            </div>

            <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
              {order.length === 0 ? (
                <p className="text-gray-500 text-center py-8">
                  No items in order.
                </p>
              ) : (
                order.map((item) => (
                  <div
                    key={item.id}
                    className="flex items-center justify-between bg-[#FDF8F0] p-3 rounded-lg"
                  >
                    <div>
                      <p className="font-semibold">{item.name}</p>
                      <p className="text-sm text-gray-500">₹{item.price}</p>
                    </div>
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => onUpdateQuantity(item.id, -1)}
                        className="w-7 h-7 rounded-full bg-red-100 text-red-700 font-bold"
                      >
                        -
                      </button>
                      <span>{item.quantity}</span>
                      <button
                        onClick={() => onUpdateQuantity(item.id, 1)}
                        className="w-7 h-7 rounded-full bg-green-100 text-green-700 font-bold"
                      >
                        +
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>

            {order.length > 0 && (
              <div className="mt-6 border-t pt-4 border-yellow-800/20">
                <div className="space-y-1 text-gray-700">
                  <div className="flex justify-between">
                    <span>Subtotal</span>
                    <span>₹{subtotal.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>GST (5%)</span>
                    <span>₹{gst.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between font-bold text-xl title-font text-black">
                    <span>Total</span>
                    <span>₹{total.toFixed(2)}</span>
                  </div>
                </div>
                <div className="mt-6 grid grid-cols-2 gap-4">
                  <button
                    onClick={onGenerateKOT}
                    className="w-full bg-[#4A4A4A] text-white py-3 rounded-lg hover:bg-black transition-colors"
                  >
                    Generate KOT
                  </button>
                  <button
                    onClick={onGenerateBill}
                    className="w-full bg-[#B8860B] text-white py-3 rounded-lg hover:bg-[#DAA520] transition-colors"
                  >
                    Generate Bill
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }

      function KOTView({
        order,
        tableNumber,
        orderId,
        onPrint,
        onClose,
        onGeneratePdf,
      }) {
        return (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-sm relative">
              <div id="kot-content" className="p-6">
                <div className="text-center mb-4 border-b pb-2">
                  <h2 className="text-2xl font-bold">K.O.T</h2>
                  <p>Kitchen Order Ticket</p>
                </div>
                <div className="flex justify-between mb-2 font-mono text-sm">
                  <span>Order #{orderId}</span>
                  <span>Date: {new Date().toLocaleDateString()}</span>
                </div>
                <div className="flex justify-between mb-4 font-mono text-sm">
                  <span>Table: {tableNumber}</span>
                  <span>Time: {new Date().toLocaleTimeString()}</span>
                </div>
                <table className="w-full text-left">
                  <thead>
                    <tr className="border-b">
                      <th className="font-semibold pb-1">QTY</th>
                      <th className="font-semibold pb-1">ITEM</th>
                    </tr>
                  </thead>
                  <tbody>
                    {order.map((item) => (
                      <tr key={item.id}>
                        <td className="py-1 font-mono">{item.quantity}</td>
                        <td className="py-1 font-semibold">{item.name}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="p-4 bg-gray-50 rounded-b-lg grid grid-cols-3 gap-2 no-print">
                <button onClick={onClose} className="bg-gray-200 py-2 rounded">
                  Close
                </button>
                <button
                  onClick={onPrint}
                  className="bg-gray-600 text-white py-2 rounded"
                >
                  Print
                </button>
                <button
                  onClick={onGeneratePdf}
                  className="bg-[#B8860B] text-white py-2 rounded"
                >
                  PDF
                </button>
              </div>
              <div id="kot-print-content" className="print-area">
                <div id="kot-content-inner" className="p-6">
                  {/* Content will be cloned here for printing */}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function BillView({
        order,
        tableNumber,
        orderId,
        subtotal,
        gst,
        total,
        onPrint,
        onNewOrder,
        onGeneratePdf,
      }) {
        return (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-sm relative">
              <div id="bill-content" className="p-6">
                <div className="text-center mb-4 border-b pb-2">
                  <h2 className="text-2xl font-bold title-font">
                    MetaStack Restaurant
                  </h2>
                  <p className="text-sm">123 Foodie Lane, Mumbai</p>
                  <p className="text-sm">GSTIN: 27ABCDE1234F1Z5</p>
                </div>
                <div className="flex justify-between mb-2 font-mono text-xs">
                  <span>
                    Bill #{orderId} | Table: {tableNumber}
                  </span>
                  <span>{new Date().toLocaleString()}</span>
                </div>

                <table className="w-full text-left text-sm">
                  <thead>
                    <tr className="border-b">
                      <th className="font-semibold pb-1">ITEM</th>
                      <th className="font-semibold pb-1 text-center">QTY</th>
                      <th className="font-semibold pb-1 text-right">PRICE</th>
                      <th className="font-semibold pb-1 text-right">AMOUNT</th>
                    </tr>
                  </thead>
                  <tbody>
                    {order.map((item) => (
                      <tr key={item.id} className="border-b">
                        <td className="py-1.5 font-semibold">{item.name}</td>
                        <td className="py-1.5 text-center">{item.quantity}</td>
                        <td className="py-1.5 text-right">
                          {item.price.toFixed(2)}
                        </td>
                        <td className="py-1.5 text-right">
                          {(item.price * item.quantity).toFixed(2)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div className="mt-4 space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span>Subtotal</span>
                    <span>₹{subtotal.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>SGST (2.5%)</span>
                    <span>₹{(gst / 2).toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>CGST (2.5%)</span>
                    <span>₹{(gst / 2).toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2">
                    <span>TOTAL</span>
                    <span>₹{total.toFixed(2)}</span>
                  </div>
                </div>
                <p className="text-center text-xs mt-6">
                  Thank you for dining with us!
                </p>
              </div>
              <div className="p-4 bg-gray-50 rounded-b-lg grid grid-cols-3 gap-2 no-print">
                <button
                  onClick={onNewOrder}
                  className="bg-gray-200 py-2 rounded"
                >
                  New Order
                </button>
                <button
                  onClick={onPrint}
                  className="bg-gray-600 text-white py-2 rounded"
                >
                  Print
                </button>
                <button
                  onClick={onGeneratePdf}
                  className="bg-[#B8860B] text-white py-2 rounded"
                >
                  PDF
                </button>
              </div>
              <div id="bill-print-content" className="print-area">
                <div id="bill-content-inner" className="p-6">
                  {/* Content will be cloned here for printing */}
                </div>
              </div>
            </div>
          </div>
        );
      }

      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
